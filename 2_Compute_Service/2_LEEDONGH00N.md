# EC2 - 2

# EC2 인스턴스 접속

인스턴스 주소는 하나 이상의 사설 ipv4 주소를 가지며, 

![Image](https://github.com/user-attachments/assets/e707b2e8-11a4-430c-b35e-b4bc0ae9c852)

주소는 아래 범위 내에서 만들어지며, 이는 사설 IP주소 할당 규약과 같다

- 인스턴스 첫 연결
    - 서브넷 내에서만 연결 가능 → 인터넷과 인스턴스를 바로 연결할 수 없음
    - 외부 리소스와 연결하기 위한 네트워크 인터페이스 설정 필요
        - 네트워크 인터페이스는 기존 서브넷 또는 보안 그룹과 반드시 연결해야 하며, 서브넷 범위 내에 정적 ip주소를 할당해서 사용할 수 있다
- 외부 인터넷과의 연결
    - 공개ip 할당
        - 기본 공개ip는 재부팅할 때 변경됨 → Elastic IP를 할당 받으면 해결 가능(비용 부담 없음)

<aside>
💡

인스턴스가 퍼블릭 또는 프라이빗 IP를 사용하는 것과 무관하게 169.254.169.254 IP를 사용할 수 있다.
→ **인스턴스 메타데이터 서비스(Instance Metadata Service, IMDS)
→  이 IP를 통해 AWS 환경 정보를 조회할 수 있다**

</aside>

# 인스턴스 보안 유지

EC2에 비인가 접근을 막기 위해 보안설정을 해야하는데, AWS는

- 보안 그룹
- IAM 롤
- NAT 인스턴스
- 키 페어

4가지 도구를 제공한다.

## 보안 그룹

✅ **보안 그룹은 인스턴스로 들어오고 나가는 네트워크 트래픽을 제어하는 방화벽입니다.**

✅ **기본적으로 모든 인바운드(들어오는) 트래픽은 차단하고, 아웃바운드(나가는) 트래픽은 허용합니다.**

✅ **특정 IP 또는 포트만 허용하여 보안을 강화할 수 있습니다.**

- 특종 트래픽의 거부 또는 허용과 관련된 정책 규칙으로 정의
    - 정의 후 유입 및 유출되는 트래픽에 대한 처리는 모두 이 규칙을 따름
- 인스턴스 관련 트래픽은 소스 및 목적지를 통해 검증됨
    - 타겟 네트워크 포트와 미리 설정된 프로토콜을 사용함
    - 패킷이 22번 포트로 전송되면, 소스 IP 주소가 우리 사무실의 컴퓨터와 연결된 로컬 공용IP와 일치할 때만 해당 인스턴스에 접속할 수 있음
    - 검증이 완료되면, 해당 인스턴스에 아무런 제약없이 접근이 가능한데, 이는 보안문제를 야기할 수 있음
- 서비스에 세심한 접속 규칙을 추가할 수 있음
    - 어드민 외에 벡엔드 서버에 접속을 못하게 막을 수 있음
- 다수의 인스턴스에 같은 규칙을 적용할 수 있음

<aside>
❓

소스? 타겟? 목적지?

| **용어** | **설명** |
| --- | --- |
| **소스(Source)** | 트래픽이 발생하는 출발지 (ex. 클라이언트, 외부 네트워크, 다른 인스턴스 등) |
| **목적지(Destination)** | 트래픽이 도달해야 하는 최종 목적지 (ex. EC2 인스턴스, RDS, 외부 서버 등) |
| **타겟(Target)** | 특정 트래픽이 전달되어야 하는 AWS 리소스 (ex. 로드 밸런서, NAT Gateway, 특정 포트) |
</aside>

<aside>
💡

보안 그룹은 인스턴스 레벨에서 트래픽을 통제하는 반면, AWS의 NACL은 서브넷 레벨에서 통제한다

</aside>

## IAM 롤

### IAM**(Identity and Access Management)**

✅ **AWS IAM은 AWS에서 사용자, 그룹, 역할(Role) 및 권한을 관리하는 서비스**

✅ **즉, 누가(AWS 사용자) 무엇을(AWS 리소스) 얼마나 할 수 있는지(권한)를 제어하는 시스템**

✅ **IAM을 사용하면 보안성을 유지하면서도 AWS 리소스를 효과적으로 관리 가능**

| **IAM 개념** | **회사 출입 시스템 비유** |
| --- | --- |
| **사용자(User)** | 회사 직원 (AWS 계정을 사용하는 사람) |
| **그룹(Group)** | 부서 (예: 개발팀, 인프라팀) |
| **역할(Role)** | 특정 임무를 맡은 외부 컨설턴트 (일시적 권한 부여) |
| **정책(Policy)** | 출입 권한 (예: 사무실 출입 가능, 서버룸 출입 가능 등) |
| **MFA (다중 인증)** | 사원증 + 비밀번호 (2단계 인증) |

<aside>
📌

 **IAM은 AWS 리소스에 대한 접근을 관리하는 “출입 통제 시스템”과 같은 역할을 함**

</aside>

예) **IAM 역할 생성 - EC2에서 S3 읽기 권한 부여**

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::my-bucket/*"
    }
  ]
}
```

📌 **즉, 이 역할은 “S3 읽기 권한”을 부여 받았으며, EC2가 이 역할을 사용할 수 있음**

⇒ IAM 롤은 누가 어떤 권한을 부여 받았는가라고 생각하면 됨

**⇒** IAM 롤을 활용하면 AWS 리소스 간 안전한 접근을 관리할 수 있음

⇒ 자세한 내용은 6장에서 다룰 예정

---

## NAT 디바이스

: 인터넷 연결 허용 없이 Private IP 주소로 인터넷에 접속할 수 있게 함

매우 중요한 업무를 담당하는 인스턴스의 경우, 네트워크 보안 유지를 위해 Public IP로 접근을 하지 못하도록 설정하기도 함. 하지만 이 경우 서버에 대한 보안 패치, 소프트웨어 업데이트 등 업무를 위한 인터넷 접속도 차단하므로 운영상문제가 발생함. 이때 NAT 디바이스를 활용하면 됨

AWS가 제공하는 NAT 디바이스에는

- NAT 인스턴스
- NAT 게이트웨이

이 2가지이다.

둘 다 월 단위로 과금되며, NAT 게이트웨이가 관리형 서비스로서 좀 더 많은 편의를 제공함

![Image](https://github.com/user-attachments/assets/8521cf26-b6f1-4513-b593-3f1c39048daf)

## 키 페어

인스턴스에 대한 원격 로그인 세션은 반드시 암호화 방식으로 연결해야 한다. 이처럼 보안 세션 실행의 방법으로 사용자는 인스턴스 생성 시 키 페어를 생성하며, 퍼블릭 키는 EC2 서버에, 프라이빗 키는 우리 로컬 머신에 저장한 뒤 사용한다. → 비대칭 암호화

- AWS가 생성한 키 페어는 인스턴스 시작 리전에 유지되며, 삭제 전까지 다른 새로운 인스턴스에도 적용 가능함.
- 퍼블릭 키를 분실했거나, 노출이 된 경우 AWS에서 해당 키 페어를 삭제하고 다시 생성해야 함

# EC2 Auto Scaling

✅ **트래픽이 많을 때 → 자동으로 EC2 인스턴스를 추가**

✅ **트래픽이 적을 때 → 불필요한 EC2 인스턴스를 종료하여 비용 절감**

✅ **EC2 인스턴스 장애 발생 시 → 자동으로 새로운 인스턴스로 교체하여 서비스 유지**

<aside>
📌

**EC2 Auto Scaling은 성능을 유지하면서도 비용을 절약하고, 서버 장애에도 자동으로 복구하는 기능**

</aside>

EC2 Auto Scaling은

- launch 환경설정
- launch 템플릿

을 이용해 시작할 인스턴스의 환경을 자동 설정하며, 인스턴스의 기본 환경 설정 파라미터 정의 및 launch 시점에 필요한 스트립트를 준비함

## Launch 환경설정 vs Launch 템플릿

- **Launch 환경설정과 Launch 템플릿은 EC2 인스턴스를 생성할 때 필요한 설정을 정의하는 방식**
- **AWS에서는 최신 기능을 지원하는 “Launch 템플릿” 사용을 권장**

| **구분** | **Launch 환경설정** | **Launch 템플릿** |
| --- | --- | --- |
| **설정 가능 항목** | 인스턴스 유형, AMI, 보안 그룹 | 인스턴스 유형, AMI, 보안 그룹 + 최신 기능 지원 |
| **수정 가능 여부** | ❌ 수정 불가 (새로 생성해야 함) | ✅ 버전 관리 기능 제공 (Git처럼 수정 가능) |
| **사용 가능 서비스** | EC2 Auto Scaling에서만 사용 가능 | EC2 Auto Scaling, EC2 복제, Spot Fleet 지원 |

<aside>
📌

**Launch 템플릿은 Launch 환경설정보다 더 유연하고 강력한 기능을 제공**

</aside>

## Auto Scaling Group

✅ **Auto Scaling 그룹은 특정 개수의 EC2 인스턴스를 자동으로 유지하는 역할을 합니다.**

✅ **최소/최대/희망 인스턴스 개수를 설정하여 원하는 범위에서 EC2 개수를 조절할 수 있습니다.**

- 그룹 생성에 앞서 Launch 템플릿을 생성해야 함

<aside>
📌

**Auto Scaling 그룹이 EC2를 관리하고, 헬스 체크와 스케일링 정책을 통해 최적의 성능을 유지함**

</aside>

### 애플리케이션 인스턴스에 대한 헬스 체크

<aside>
📌

**헬스 체크(Health Check)는 인스턴스의 상태를 모니터링하여 정상적으로 동작하는지 확인하는 기능**

</aside>

| **헬스 체크 유형** | **설명** |
| --- | --- |
| **EC2 헬스 체크** | 인스턴스가 실행 중인지 확인 (네트워크 장애, OS 오류 감지, 메모리 고갈 등) |
| **ELB 헬스 체크** | 로드 밸런서를 통해 애플리케이션이 정상 응답하는지 확인 (HTTP 상태 코드 체크) |

**⇒ EC2 헬스 체크는 “서버 자체 상태”를 확인하고, ELB 헬스 체크는 “애플리케이션 정상 동작 여부”까지 감지**

Auto Scaling 그룹을 생성하면 미리 정한 최소 또는 희망 용량의 인스턴스가 항상 유지되며, 생성된 인스턴스의 헬스 상태가 좋지 못하면 Auto Scaling이 이를 삭제하고 삭제하고 새 인스턴스(Launch Template)로 대체 

- Auto Scaling의 인스턴스 헬스에 대한 판단 기준 : EC2 헬스 체크를 따름
- 헬스 체크를 통해 메모리 고갈, 파일 시스템 오류, 네트워크 연결 오류, 시작 환경설정 오류뿐만 아니라 AWS가 처리해야 하는 시스템 문제여부까지 확인 가능
- 인스턴스 및 호스팅과 관련된 문제점을 발견할 수 있지만, 애플리케이션에 특화된 문제점은 발견하지 못함

ALB를 통해 인스턴스의 트래픽을 라우팅 시

- 로드 밸런서의 타겟 그룹에 대한 헬스 체크 환경설정 가능
- 타겟 그룹의 헬스 체크 : HTTP 응답 코드 확인 가능 (200 ~ 499)
- Auto Scaling 그룹의 환경 설정을 통해 헬스 체크 확인 결과를 인스턴스 상태 모니터링에 반영할 지 결정 가능
- ALB 헬스체크 실패 시 로드밸런서는 해당 인스턴스에 대한  트래픽 전송을 중단하고, 인스턴스를 삭제 및 다른 인스턴스로 대체하고 ALB 타겟 그룹에 새 인스턴스를 추가한 뒤 새 인스턴스에 트래픽을 전송

### 스케일링 정책 설정

<aside>
📌

**트래픽 변화에 따라 EC2 개수를 자동으로 조절하는 정책을 설정**

</aside>

Auto Scaling 그룹 생성 시

- Launch 템플릿(환경설정)로 몇 개의 인스턴스를 생성하고 실행해야 할까?
- 최대, 최소 용량?
- 희망하는 인스턴스 수?
1. 최소 용량 Auto Scaling
    
    : 인스턴스의 수가 최소 크기 이하로 내려가지 않도록 함
    
    - 이 값을 0으로 설정하면 Auto Scaling은 새 인스턴스를 추가하지 않고, 그룹 내 인스턴스 모두 종료
2. 최대 용량 Auto Scaling
    
    : 인스턴스의 수가 최대 크기 이상이 되지 않도록 함
    
    - 예산 제한선을 고려해 예기치 못한 수요에 의해 지나치게 많은 인스턴스가 추가되지 않도록 안정장치 역할을 함
3. 희망 용량 Auto Scaling
    
    : 사용자의 필요에 따라 선택적으로 입력이 가능 (최소 ~ 최대 범위 안에 있어야 함)
    
    - 입력하지 않으면 Auto Scaling은 최소 크기에 맞춰 인스턴스를 launch함
    - 입력하면 이에 맞춰 인스턴스를 생성 또는 추가함
    - 콘솔에선 그룹 사이즈라는 용어로 불림
    

1️⃣ **최소 용량(Minimum Capacity)** → 2개 (이보다 적어지지 않음)

2️⃣ **최대 용량(Maximum Capacity)** → 10개 (이보다 많아지지 않음)

3️⃣ **희망 용량(Desired Capacity)** → 4개 (일반적으로 유지되는 개수)

## AutoScaling 옵션

### 수동 스케일링

Auto Scaling 그룹 생성 후 최소, 최대, 희망 용량 값을 변경하면, 해당 내용은 즉시 반영됨

### 동적 스케일링 정책

대부분의 AWS 관리형 리소스는 탄력적이다. 워크로드가 증가하면 자동으로 성능 또는 용량을 스케일업 하며, 이 서비스들에 대해서 트래픽이 아무리 급증해도 AWS가 그에 대응해서 리소스를 추가함. 하지만 EC2 인스턴스의 경우 요구 수준에 맞는 성능 또는 용량을 설정하는 것은 사용자의 책임임

CPU 활성화율, 메모리, 디스크 공간 등 인스턴스 리소스 고갈은 인스턴스 가동 실패로 이어지며, 사용자는 동적 스케일링 정책을 통해 중단 임계치에 도달하기 전에 인스턴스의 부담을 줄여줘야 한다.

<aside>
📌

**CloudWatch 모니터링 데이터를 기반으로 EC2 개수를 자동 조절**

</aside>

⇒ 동적 스케일링 정책은 CloudWatch의 경고상황을 모니터링한 결과에 따라 희망 용량을 증가시키는 방식으로 작동하며, 단순 정책, 단계별 정책, 타겟 추적 정책 총 3가지가 있음

### 단순 스케일링 정책

지표가 한계치에 도달하면 Auto Scaling이 희망 용량대로 인스턴스를 증가시키되, 다음과 타입에 따라 증가 수준을 조절함

<aside>
📌

**예:** CPU 사용률 70% 초과 시 **EC2 1대 추가**

</aside>

- ChangeInCapacity : 지정 숫자만큼 희망 용량을 증가시킴
- ExactCapacity : 현재 값에 상관 없이 용량을 지정 숫자만큼 증가시킴
- PercentChangeInCapacity : 현재 용량의 비율을 기준으로 증가시킴

Auto Scaling 조정 작업 종료 후 관련 정책을 다시 실행하기 전 휴식기(cooldown period)를 가짐

- 기본 : 300초
- 인스턴스의 헬스 상태가 좋지 않은 경우 휴식기 없이 해당 인스턴스를 교체

### 단계별 스케일링 정책

애플리케이션에 대한 요구 수준이 급속히 증가할 경우, 단순 스케일링 정책만으론 수요에 적절히 대응할 수 없으며, 단계별 스케일링 정책을 통해 리소스 사용량의 누적 지표에 따라 인스턴스를 추가할 수 있어야 한다.

단계별 스케일링 정책을 작성할 때는 최소 한 단계에 해당하는 조정 값 또는 범위를 지정해야 한다.

<aside>
📌

**트래픽 증가 정도에 따라 EC2 개수를 다르게 조정

예)**

- CPU 50~60% → **EC2 2대 추가**
- CPU 60~70% → **EC2 3대 추가**
- CPU 70% 이상 → **EC2 4대 추가**
</aside>

단계별 조정 값은

- 하위 경계
- 상위 경계
- 조정 타입
- 희망 용량 증가 기준

상위 경계 및 하위 경계는 단계별 조정 업무를 수행할 지표의 범위를 정의한다. 초기 단계를 하위 경계 50, 상위 경계 60으로 설정하고, ChangeInCapacity 조정값을 2로 설정하면 알람 발령 시 Auto Scaling은 평균 CPU 활성화율을 기준으로 조정에 나선다

이번 예에서 평균 CPU 활성화율이 55%라면 55가 하위 경계, 상위 경계 60 범위에 있으므로 Auto Scaling은 희망 용량에 2를 추가한다.

하위 경계 60, 상위 경계 무한으로 설정하고 ChangeInCapacity는 4인 경우, 평균 CPU 활성화율이 62%라면 Auto Scaling의 60≤62<무한 의 조건이 만족하므로 희망 용량에 4를 추가한다. CPU 활성화율이 60%라면 어떻게 될까? 단계별 숫자 범위는 겹칠 수 없으며 60%는 하위 경계와 겹치므로 희망 용량에는 변화가 없게 된다.

단계별 스케일링 정책에서는 Auto Scaling이 새 인스턴스 추가를 위해 대기하는 시간인 준비기(warm-up time)를 여러분이 지정할 수 있으며 기본 준비시간은 300초이며, 단계별 스케일링 정책은 휴식기는 갖지 않는다.

### 목표 추적 정책

단계별 스케일링 정책이 너무 복잡하다. 이럴 때 목표 추적 정책을 사용하면 된다.

특정 지표와 타겟 값을 선택하면, Auto Scaling이 CloudWatch Alarm 생성, 인스턴스 개수 조정을 위한 스케일링 정책 생성 등 제반 업무를 처리한다.

목표 추적 정책에서는 용량을 증가시키는 스케일아웃 정책은 물론 용량을 감소시키는 스케일인 정책도 추가할 수 있다. 스케일인 정책을 원치 않는 경우 스케일인 정책을 비활성화시킨다. 또한 목표 추적 정책에서도 단계별 스케일링 정책처럼 준비기를 설정할 수 있다.

<aside>
📌

목표값을 설정하면 AWS가 자동으로 EC2 개수를 조정

**예:**

- 목표 CPU 사용률을 50%로 설정 → AWS가 자동으로 EC2 개수를 조절하여 50% 유지
</aside>

### 예약된 작업

우리의 워크로드 패턴이 예측 가능한 경우나 용량 변화에 선제적으로 대응해 수요 증가 이전에 충분한 인스턴스를 확보하고자 할 때 유용하다.

예약된 작업 생성 시, 다음 사항을 설정한다.

- 최소,최대 희망 용량 값
- 시작 날짜 및 시간

반복적인 패턴으로 업무를 처리하는 경우엔 일정 기간마다 반복되는 정책을 추가할 수 있고, 예약된 정책을 삭제하기 위한 종료 시점도 설정할 수 있다.

예를 들어, 여러분이 Auto Scaling 그룹을 이용해 평소에는 일주일에 두 개의 인스턴스를 실행하고, 트래픽이 급증하는 금요일엔 네 개의 인스턴스를 실행하려 한다고 생각해 보자.

이를 예약된 작업으로 처리하려면 먼저, 트래픽 급증 상황에 대응하기 위해 매주 금요일에 희망 용량을 4로 올리는 정책을 생성한다. 다음, 토요일에 희망 용량을 평소 수준인 2로 되돌리는 정책을 추가한다.

이와 같은 예약된 작업 정 책은 매주 금요일에 자동으로 인스턴스를 확장했다가 토요일에 원래 수준의 인스턴스로 축소하게 된다. 이와 같이 동적 스케일링 정책은 몇 개의 예약된 작업을 결합해서 사용하는 것도 가
능하다. 

예를 들어, 온라인 쇼핑몰을 운영한다면, 손님이 몰리는 쇼핑 시즌에는 그룹 크기를 최대로 증가시키는 예약된 작업을 적용한 뒤, 상황에 따라 희망 용량을 증감시키는 정책을 동적으로 적용할 수 있다.

<aside>
📌

특정 시간에 EC2 개수를 조정

**예:**

- 매일 오전 9시에 EC2 10개로 증가
- 오후 6시에 EC2 4개로 축소
</aside>
