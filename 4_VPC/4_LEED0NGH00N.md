# VPC - 1

[240903_2_Web App.pdf](VPC%20-%201%201abcb0a994c580fa920ee80b2a81a8fe/240903_2_Web_App.pdf)

# 들어가기에 앞서

VPC를 이해하기 전에 아래 개념들을 숙지하면 좋을 것 같습니다.

## IP

### **Public IP**

인터넷망에서 한 단말에서 한 단말로 접속할 수 있는 주소로 인터넷 망 내부에서 고유한 존재

- 어느 한 군데에서 사용 중이라면 다른 곳에서 사용할 수 없습니다.

### **Private IP**

Public IP 대역 내 사설 네트워크로 지정된 대역으로서, Public IP에서는 해당 대역을 사용하지 않고 오로지 외부 인터넷과 관련되지 않는 내부 사설 네트워크에 서만 사용

- Public IP는 현재 IPv4의 경우, 총 42억 개를 사용할 수 있습니다. 인터넷 초창기에는 넉넉한 숫자였지만 요즘처럼 인터넷이 대중화된 시대에 는 매우 부족해서 사설 IP를 사용한다.

## 🌟 서브넷

### **클래스 기반 주소 방식 (Classful Addressing) → 고정된 네트워크 크기**

| **클래스** | **시작 비트** | **네트워크 범위 (10진수)** | **네트워크/호스트 비트** | **용도** |
| --- | --- | --- | --- | --- |
| A | 0xxxxxxx | 1.0.0.0 ~ 126.255.255.255 | 네트워크 8비트 + 호스트 24비트 | 대규모 네트워크 (기업, ISP) |
| B | 10xxxxxx | 128.0.0.0 ~ 191.255.255.255 | 네트워크 16비트 + 호스트 16비트 | 중간 규모 네트워크 |
| C | 110xxxxx | 192.0.0.0 ~ 223.255.255.255 | 네트워크 24비트 + 호스트 8비트 | 소규모 네트워크 |
| D | 1110xxxx | 224.0.0.0 ~ 239.255.255.255 | 멀티캐스트(Multicast) |  |
| E | 1111xxxx | 240.0.0.0 ~ 255.255.255.255 | 연구용(Reserved) |  |

위 표를 기반으로 C클래스는 호스트 비트가 24비트이므로 총 $2^{8} - 2$ 개의 호스트 ID를 가진다. 

내가 `192.167.1.0`라는 C 클래스 네트워크의 소유주라 가정하자. 어느 기관이 나에게 30개의 호스트를 빌려달라고 했을 때 난 딱 30개만 줄 수가 없고 네트워크 안에 있는 호스트 전부를 줘야 한다. 그러면 사용하지 않는 호스트들의 낭비가 있어 좋지 않다. 

### **서브넷(Subnet) → 네트워크를 더 세분화하기 위한 개념**
![Image](https://github.com/user-attachments/assets/087969b8-0abf-4243-9f9e-eb2b36cca738)

IP주소는 네트워크 ID와 호스트 ID로 이뤄져 있다. 기존 클래스 기반 주소 방식은 네트워크와 호스트를 구분하는 기준이 클래스 별로 정해져 있었다면, 서브넷은 **서브넷 마스크**를 사용해 구분한다.

여기서 서브넷은 IP주소의 네트워크 영역의 부분 네트워크란 뜻이다. 

<aside>
📌서브넷 마스크 : IP주소 체계에서 네트워크와 호스트를 구분하는 역할

`192.167.1.0/24` ⇒ 앞에서부터 24번째 비트까지가 네트워크, 그 뒤부터 호스트 (/24 = 서브넷 마스크)

/24 ⇒ 앞 24개 비트 : 1, 나머지 : 0

</aside>

### 서브넷팅

클래스 기반 주소 방식에서 네트워크 ID의 길이는 고정되어 있다. C 클래스를 예로 들면, 네트워크가 `192.167.1.0` 로 고정되어 있다. 이를 서브넷 마스크를 활용해 표현을 하면 `192.167.1.0/24` 로 표현할 수 있는데, 문제는 `192.167.1.0/24`는 자기 자신의 네트워크 안에 있는 모든 호스트를 관리해야 하는데, 이게 총 $2^8 - 2$ 개다.

할당을 원하는 호스트의 개수가 $2^8 - 2$ 개 이하일 경우 호스트가 낭비된다는 문제와 더불어, `192.167.1.0/24`  네트워크가 자신에게 속해있는 모든 호스트를 관리해야 한다. 이때 등장하는 개념이 서브넷팅이다.

서브넷팅은 IP 주소 낭비를 최소화하기 위해 원본 네트워크를 여러 개의 서브넷으로 분리하는 과정이다. 쉽게 말해, 서브넷 마스크의 비트 수를 1 증가 시킨다고 보면된다. 이로 인해 할당할 수 있는 네트워크 개수가 2배 늘고, 호스트의 수는 2배 줄어든다.

`192.167.1.0/24` 에서 서브넷팅하면 `192.167.1.0/25` 가 되는데, 이때 할당 가능한 호스트의 개수가 $2^{8} - 2$에서 $2^{7} - 2$로 줄어든다. 

또한 기존`192.167.1.0/24` 의 네트워크가 `192.167.1.0/25` 과 `192.167.1.128/25` 2개로 네트워크(서브넷)가 1개에서 2개가 되었다.

<aside>
📌서브넷팅 : 서브넷 마스크의 비트 수 1 증가

</aside>

[[네트워크] 서브넷,  서브넷마스크, 서브넷팅이란? | 서브넷팅 예제](https://code-lab1.tistory.com/34)

## 🌟 CIDR(Classless Inter Domain Routing)

**: 클래스 없이 완전히 유연한 네트워크 할당 방식**

**🚀 개념**

- 기존 **클래스 A/B/C 개념을 없애고, 네트워크 크기를 자유롭게 조정**하는 방식.
- /숫자 표기법을 사용해 **네트워크 크기를 정확히 지정**할 수 있음.

**🚀**  **CIDR 표기법 = “IP 주소 / 네트워크 비트 개수 (연속된 1의 개수)”**

- 192.168.1.0/24 → **24비트는 네트워크, 8비트는 호스트**
- 192.168.1.0/26 → **26비트는 네트워크, 6비트는 호스트 (더 작은 네트워크)**

<aside>
💡Q : 192.168.1.0 네트워크 범위가 어디까지인데?? 
  A : 192.168.1.0/**24**

</aside>

위에서 설명한 서브넷팅도 IP 클래스에 국한되지 않고 IP 주소를 쪼개는 방식이라서 이 또한 도메인 간 라우팅 기법이다.

<aside>
📌**서브넷팅 ⊂ CIDR**
</aside>

# VPC란?

:  **가상의(논리적인) 네트워크**

![Image](https://github.com/user-attachments/assets/48971f9a-1ad6-4405-913f-cefe1793eb16)

VPC는 여러 가용영역에 걸친 형태로 생성할 수 있는데, 물리적으로는 다른 곳에 위치하지만 같은 IP 대역에 위치하게 만들어 리소스들끼리 통신할 수 있게 만들어주는 기술이다.

![Image](https://github.com/user-attachments/assets/1a3db5d0-5244-4494-b287-dd18aeb89958)

VPC에는 리전의 각 가용 영역에 하나의 서브넷이 있고, 각 서브넷에 인스턴스가 있고 VPC의 리소스와 인터넷 간의 통신을 허용하는 인터넷 게이트웨이가 있다.

비유하자면

- 아파트 단지(VPC)에
- 여러 아파트 동(서브넷)이 있고
- 각 동에는 여러 세대(리소스)가 있다.
- +) 추가로
    
    AWS 계정을 생성하면 모든 리전에 기본 VPC를 만들어주는데, 공유 네트워크라 만약 다른 사람이 자신의 계정으로 기본 VPC에서 네트워크 부하가 많은 작업을 한다면, 이는 내 서버에도 영향을 미친다. 
    
<img width="1172" alt="Image" src="https://github.com/user-attachments/assets/70d4422c-e5e3-480b-90b7-7559ba6650dd" />

    

### VPC의 구성

![Image](https://github.com/user-attachments/assets/af361f5d-53e2-4f5a-92c1-bef84b689753)

# VPC CIDR

VPC는 CIDR로 표시한다. 이 CIDR은 VPC 내의 인스턴스 및 리소스에 할당하는 IP 주소를 결정한다.

우리가 VPC를 만들 때는 기본 CIDR을 할당해야 하고, VPC 생성 후에는 기본 VPC CIDR을 서브넷으로 나눠서 사용하게 된다.

## VPC CIDR 표기법

- 빗금 문자 표기법
    - ex. `172.16.0.0/16` ⇒ `172.16.0.0` 부터 `172.16.255.255`까지 총 65536개의 주소를 포함함
- CIDR 블록에서 /{prefix} = 서브넷 마스크의 길이
    - /16 ~ /28 까지 가능
        - VPC 생성 시
          
            <img width="686" alt="Image" src="https://github.com/user-attachments/assets/47f9660b-1001-4afb-a106-1b5ba977c9c8" />
            
    - prefix가 커지면 IP 주소의 개수는 줄어든다 (역 관계)
- VPC를 생성할 때 RFC 1918의 Private IPv4 주소 범위에 속하는 CIDR 블록을 지정하는 것이 좋다
    
    ![Image](https://github.com/user-attachments/assets/7e4803a9-546f-4ea8-96e4-9f79cbf513e3)
    
    - VPC를 다른 네트워크에 연결하려면 사용하려는 VPC CIDR이 다른 네트워크에서 이미 사용하는 주소와 중복되지 않도록 해야 함

<aside>
💡

Amazon EC2 API를 사용하여 VPC를 생성하면 CIDR 블록이 표준 형식으로 자동 수정된다
예를 들어 CIDR 블록에 100.68.0.18/18을 지정하면 100.68.0.0/18의 CIDR 블록이 생성된다.

</aside>

<aside>
⚠️VPC 생성 후에는 기본 CIDR은 변경할 수 없으므로, VPC를 만들기 전 주소 요구사항을 신중히 검토해야 한다

</aside>

### 보조 CIDR 블록

VPC를 만든 후에도 보조 CIDR을 지정할 수 있다.

- 기존 VPC의 IP주소가 부족할 때 추가적인 네트워크 범위를 확장하기 위해 쓰인다
- 보조 CIDR은 기본 CIDR 주소 범위나 퍼블릭에서 라우팅 가능한 범위 내에 생성돼야 한다
- 기본 CIDR 또는 다른 보조 CIDR과 겹쳐도 상관 없다

ex) VPC 기본 CIDR이 `172.16.0.0/16`인 경우

→ 보조 CIDR을 `172.17.0.0/16`으로 지정할 수 있는데, 이는 보조 CIDR의 범위가 `172.16.0.0/12` 범위에 포함돼 있기 때문이다. 

→ 하지만 보조 CIDR을 `192.168.0.0/16`으로 지정할 수는 없다. 기본 CIDR 주소 범위를 벗어낫기 때문(네트워크  ID를 넘어감)

<aside>
⚠️보조 CIDR이 필요할 수 있겠다고 생각한다면, 기본 CIDR을 신중히 선택해야 한다. 기본 CIDR을 `192.168.0.0/16`로 지정하면, RFC 1918 범위에 부합하는 보조 CIDR을 만들 수 없기 때문이다.

</aside>

## IPv6 CIDR

VPC에 IPv6 CIDR을 할당하는 것도 가능하나, 

- IP Prefix를 지정할 수 없다
- 원하면 AWS에 요청하여 VPC에 IPv6 CIDR을 할당해 글로벌 유니캐스트 IPv6 주소 공간에서 퍼블릭 라우팅이 가능한 IP 프리픽스로 사용될 수 있다
    - 이 경우 프리픽스는 항상 `/56`이다

# 서브넷

: VPC 리소스(e.g. EC2 인스턴스)를 연결한다.

- 네트워크 상에 존재하는 여러 인스턴스를 서로 격리해줌
- 인스턴스 간의 트래픽 유입 및 유출을 제어, 기능별로 조직화
- VLAN과 유사한 개념
- 인스턴스는 서브넷 내에 생성 뒤엔 다른 서브넷으로 옮길 수 없다
    
    ⇒ 하나의 VPC에서 생성된 인스턴스를 다른 VPC로 옮길 수 없다
    
    ⇒ 기존 인스턴스의 EBS 볼륨 내 데이터를 보존한 채로 서브넷을 옮겨야 한다면 볼륨 스냅샷 생성, AMI 생성 그리고 AMI를 이용해 원하는 서브넷에서 새 인스턴스를 시작해야 한다.
    

### 서브넷 CIDR

: VPC 영역 중 일부를 떼서 사용

ex. VPC CIDR : `172.16.0.0/16`

서브넷 CIDR : `172.16.1.0/24`가 될 수 있고, IP 주소의 범위는 `172.16.1.0` ~ `172.16.1.255` 총 256개 사용 가능

- AWS 모든 서브넷은 처음 4개의 IP주소와 마지막 1개 IP주소는 예약돼 있어 이 주소로 IP를 할당할 수 없다.
    
    ex. 서브넷 CIDR : `172.16.1.0/24`
    
    - `172.16.1.0`
    - `172.16.1.1` : 내재된 라우터용
    - `172.16.1.2` : 아마존 제공 DNS 서버용
    - `172.16.1.3` : 예비로 예약
    - `172.16.1.255`
- 프리픽스 제한 : VPC CIDR과 같다
    - VPC내에 있는 서브넷 CIDR 블록끼리 겹치면 안되고
    - 서브넷에 CIDR을 할당한 후 변경이 안된다
- 서브넷과 VPC가 동일한 CIDR을 공유할 수 있다
    - `172.16.1.0/24` 를 VPC와 CIDR 모두에게 할당할 수 있다
    - 단 하나의 가용영역에만 해당 서브넷을 사용하도록 하기 위해 이런 방식을 사용할 수 있다
- 서브넷의 프리픽스를 VPC보다 길게 한다
    
    ⇒ 한 VPC에 여러 서브넷을 두기 위함
    
- 서브넷은 여러 CIDR을 가질 수 없다
    - VPC는 보조 CIDR을 가질 수 있지만, 서브넷은 둘 중 하나만 선택해야 한다.

### 가용 영역(AZ)

: 리전에 비해 더 작은 지리적 영역

- 한 리전의 가용 영역들은 서로 연결돼 있고, 하나의 가용영역에 장애가 발생해도 다른 가용영역에 영향을 미치지 않게 설계된다

서로 다른 가용영역에 서브넷을 하나씩 만들고, 인스턴스를 각 서브넷에 분산 배치해 애플리케이션의 복원성을 구현할 수 있다. 

![Image](https://github.com/user-attachments/assets/d1ace642-779f-433e-a851-182bd2086e14)
![Image](https://github.com/user-attachments/assets/4f8c5295-3955-4ab3-8894-2633f8b2e71f)

us-east-1a 가용영역에 장애가 발생하면 

→ web1 인스턴스는 해당 영역에 있기 때문에 문제가 발생하지만

→ us-east-1b 영역 인스턴스인 web2는 문제가 없어 계속 사용이 가능하다

즉, 모든 서브넷을 같은 가용영역에 배치를 한다면 장애 발생시 모든 인스턴스가 동작하지 않을 수 있다.

### IPv6 CIDR 블록

VPC에 IPv6 CIDR을 할당하면, 해당 VPC 내 서브넷에 IPv6 CIDR을 할당할 수 있는데,

- 프리픽스 : /64로 고정

<aside>
💡

IPv6만 사용한다 하더라도 서브넷에는 반드시 IPv4 CIDR 블록을 할당해야 한다.

</aside>

## Public Subnet & Private Subnet

### Public Subnet

: VPC 외부와 자유로운 통신이 가능한, 외부 인터넷 구간과 직접적으로 통신이 가능한 네트워크

### Private Subnet

: 외부에서 직접 접근할 수 없고, NAT GateWay를 이용해 단방향 통신(내부 → 외부)만 가능한 네트워크

# Elastic Network Interface (ENI)

: 인스턴스가 다른 네트워크 리소스와 통신할 수 있게 하는 인터페이스

- 네트워크 인터페이스 : 컴퓨터가 네트워크에 연결되어 통신하기 위한 물리적인 혹은 가상의 연결포인트
    <center>
    ![Image](https://github.com/user-attachments/assets/448285f7-ebf9-4ccb-a05d-437a24da3f08)
    </center>
    
- 인스턴스에서 실행되는 OS와도 통신 가능
- 물리적 서버의 네트워크 인터페이스와 같은 기능을 제공
    - MAC 주소가 있다
- 하나의 서브넷에만 연결됨(?)
    
    ⇒ 인스턴스를 시작할 때 서브넷을 지정하는 이유
    

### 기본 private IP 주소 및 보조 private IP 주소

각 인스턴스는 서브넷으로 지정한 범위 내의 기본 private ip 주소를 지녀야 하며, 기본 private ip 주소는 인스턴스의 ENI와 연결된다.

- 기본 private IP 주소는 바꾸거나 삭제할 수 없다
- 기본 ENI에 보조 private IP 주소를 할당할 수 있다
    - 보조 private IP 주소는 ENI가 부착된 서브넷 범위 내에 있어야 한다.
- ENI를 인스턴스에 추가해 연결이 가능하고, 이 ENI를 다른 서브넷에 둘 수 있다.
    - 대신 인스턴스와 동일한 가용 영역 내에 있어야 한다.
- ENI에 할당된 주소는 서브넷에 부착된 private IP 주소 범위 내에 있어야 한다.

### ENI 부착하기

ENI는 인스턴스와 독립적으로 존재할 수 있으며, ENI를 만들고 인스턴스에 부착할 수 있다.

또한 장애가 있는 인스턴스에 붙어있던 ENI를 분리해서 다른 인스턴스에 연결해 트래픽을 장애 인스턴스에서 정상 인스턴스로 전환할 수 있다. (?)

[[발표자료] Amazon VPC Deep Dive: ENI 를 알면 VPC 가 보인다 | DevelopersIO](https://dev.classmethod.jp/articles/amazon-vpc-eni-deep-dive/)

### 성능 강화 네트워크

- ENI에 비해 고속의 네트워크 처리 속도 및 저지연성 제공
- 단일 루트 입출력 가상화(SR-IOV) 기법 사용
    - 동일한 물리적 서버에서 호스팅되고 있는 다수의 인스턴스가 하이퍼바이저를 우회할 수 있도록 하므로 좀 더 낮은 CPU 활성화 수준 및 높은 네트워크 성능을 제공

이 네트워크를 사용하려면, 인스턴스 OS에 성능강화 네트워크를 지원해주는 드라이버가 설치돼야 한다.

→ Amazon Linux, Ubuntu HVM AMI에는 ENA 지원 기능이 기본적으로 탑재돼 있다.

# 인터넷 게이트웨이 (IGW)

: VPC와 인터넷을 연결하며, 인터넷에서 들어온 요청을 퍼블릭 서브넷의 리소스가 수신할 수 있게 하고, 반대로 퍼블릭 서브넷의 리소스가 인터넷에 연결할 수 있다.

- 기본 VPC는 인터넷 게이트웨이 제공
    - 커스텀할 경우 직접 만들어야 한다.
- 하나의 VPC에는 하나의 인터넷 게이트웨이만
    - 여러 인터넷 게이트웨이를 생성하고 여러 VPC를 인터넷으로 연결해 사용할 수 있음

### 라우터와의 차이점

<전통적인 네트워크>

서버가 인터넷과 연결하기 위해

- 코어 라우터의 기본 라우트가 인터넷 라우터의 내부 IP 주소를 가리키도록 설정해야 함

<AWS의 인터넷 게이트웨이>

- IP주소, 네트워크 인터페이스가 없고, AWS 리소스 ID를 식별용으로 할당
- 리소스 ID는 igw-로 시작

<aside>
💡인터넷 게이트웨이를 사용하려면 라우트 테이블에 인터넷 게이트웨이를 타겟으로 하는 기본 라우트를 생성해야 한다.

</aside>
<center>
![Image](https://github.com/user-attachments/assets/ed04ce35-e2bb-4e14-833c-6c7738e87f93)
</center>
